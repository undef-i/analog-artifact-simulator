<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ntsc-wasm</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css"
        integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"
        integrity="sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx"
        crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"
        integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05"
        crossorigin="anonymous"></script>
    <style>
        body {
            max-width: 900px;
            margin: 0 auto;
            padding: 10px;
        }

        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 10px 0;
        }

        .image-container {
            display: flex;
            gap: clamp(10px, 4vw, 20px);
            justify-content: center;
        }

        .image-section {
            flex: 1;
            text-align: center;
        }

        .image-section img {
            width: 100%;
            height: auto;
        }
    </style>
</head>

<body>
    <h1>ntsc-wasm</h1>

    <p>A comprehensive analog video artifact simulator that accurately reproduces classic video imperfections including dot crawl patterns, signal ringing, chroma noise distortion, color bleeding effects, and authentic VHS-style degradation.
    </p>

    <p><em>This implementation is inspired by the <a href="https://ntsc.rs" target="_blank">ntsc-rs</a> project.</em>
    </p>


    <div id="wasmStatus">Loading WebAssembly module...</div>

    <h3>Select Image</h3>
    <input type="file" id="fileInput" accept="image/*">

    <h3>Presets</h3>
    <button onclick="loadPreset('default')">Default</button>
    <button onclick="loadPreset('composite')">Composite</button>
    <button onclick="loadPreset('vhs')">VHS</button>
    <button onclick="loadPreset('broadcast')">Broadcast</button>
    <button onclick="loadPreset('vanilla')">Vanilla</button>
    <h3>Controls</h3>
    
    <!-- Composite Signal Controls -->
    <details open>
        <summary><strong>Composite Signal</strong></summary>
        <div class="control-group">
            <div class="control-item">
                <label>Composite Preemphasis:</label>
                <input type="range" id="compositePreemphasis" min="0" max="8" step="0.1" value="0.0">
                <span id="compositePreemphasisValue">0.0</span>
            </div>
            <div class="control-item">
                <label>Preemphasis Cut Frequency:</label>
                <input type="range" id="compositePreemphasisCut" min="100000" max="2000000" step="10000" value="1000000">
                <span id="compositePreemphasisCutValue">1000000</span>
            </div>
            <div class="control-item">
                <input type="checkbox" id="compositeInChromaLowpass" checked> Composite In Chroma Lowpass
            </div>
            <div class="control-item">
                <input type="checkbox" id="compositeOutChromaLowpass" checked> Composite Out Chroma Lowpass
            </div>
            <div class="control-item">
                <input type="checkbox" id="compositeOutChromaLowpassLite" checked> Composite Out Chroma Lowpass Lite
            </div>
        </div>
    </details>

    <!-- Color and Bleeding Controls -->
    <details open>
        <summary><strong>Color & Bleeding</strong></summary>
        <div class="control-group">
            <div class="control-item">
                <input type="checkbox" id="colorBleedBefore" checked> Color Bleed Before
            </div>
            <div class="control-item">
                <label>Color Bleed Horizontal:</label>
                <input type="range" id="colorBleedHoriz" min="0" max="20" step="1" value="0">
                <span id="colorBleedHorizValue">0</span>
            </div>
            <div class="control-item">
                <label>Color Bleed Vertical:</label>
                <input type="range" id="colorBleedVert" min="0" max="20" step="1" value="0">
                <span id="colorBleedVertValue">0</span>
            </div>
            <div class="control-item">
                <input type="checkbox" id="noColorSubcarrier"> No Color Subcarrier
            </div>
            <div class="control-item">
                <label>Subcarrier Amplitude:</label>
                <input type="range" id="subcarrierAmplitude" min="0" max="100" step="1" value="50">
                <span id="subcarrierAmplitudeValue">50</span>
            </div>
        </div>
    </details>

    <!-- Ringing and Frequency Controls -->
    <details open>
        <summary><strong>Ringing & Frequency</strong></summary>
        <div class="control-group">
            <div class="control-item">
                <label>Ringing:</label>
                <input type="range" id="ringing" min="0" max="3" step="0.1" value="1.0">
                <span id="ringingValue">1.0</span>
            </div>
            <div class="control-item">
                <input type="checkbox" id="enableRinging2"> Enable Ringing 2
            </div>
            <div class="control-item">
                <label>Ringing Power:</label>
                <input type="range" id="ringingPower" min="1" max="5" step="1" value="2">
                <span id="ringingPowerValue">2</span>
            </div>
            <div class="control-item">
                <label>Ringing Shift:</label>
                <input type="range" id="ringingShift" min="-10" max="10" step="1" value="0">
                <span id="ringingShiftValue">0</span>
            </div>
            <div class="control-item">
                <label>Frequency Noise Size:</label>
                <input type="range" id="freqNoiseSize" min="0" max="10" step="0.1" value="0">
                <span id="freqNoiseSizeValue">0</span>
            </div>
            <div class="control-item">
                <label>Frequency Noise Amplitude:</label>
                <input type="range" id="freqNoiseAmplitude" min="0" max="10" step="0.1" value="2">
                <span id="freqNoiseAmplitudeValue">2</span>
            </div>
        </div>
    </details>

    <!-- Noise Controls -->
    <details open>
        <summary><strong>Noise</strong></summary>
        <div class="control-group">
            <div class="control-item">
                <label>Video Noise:</label>
                <input type="range" id="videoNoise" min="0" max="100" step="1" value="2">
                <span id="videoNoiseValue">2</span>
            </div>
            <div class="control-item">
                <label>Chroma Noise:</label>
                <input type="range" id="videoChromaNoise" min="0" max="500" step="1" value="0">
                <span id="videoChromaNoiseValue">0</span>
            </div>
            <div class="control-item">
                <label>Chroma Phase Noise:</label>
                <input type="range" id="videoChromaPhaseNoise" min="0" max="100" step="1" value="0">
                <span id="videoChromaPhaseNoiseValue">0</span>
            </div>
            <div class="control-item">
                <label>Chroma Loss:</label>
                <input type="range" id="videoChromaLoss" min="0" max="100000" step="100" value="0">
                <span id="videoChromaLossValue">0</span>
            </div>
        </div>
    </details>

    <!-- VHS Controls -->
    <details>
        <summary><strong>VHS Effects</strong></summary>
        <div class="control-group">
            <div class="control-item">
                <input type="checkbox" id="emulatingVHS"> Emulating VHS
            </div>
            <div class="control-item">
                <label>VHS Out Sharpen:</label>
                <input type="range" id="vhsOutSharpen" min="0" max="5" step="0.1" value="1.5">
                <span id="vhsOutSharpenValue">1.5</span>
            </div>
            <div class="control-item">
                <label>VHS Edge Wave:</label>
                <input type="range" id="vhsEdgeWave" min="0" max="10" step="1" value="0">
                <span id="vhsEdgeWaveValue">0</span>
            </div>
            <div class="control-item">
                <input type="checkbox" id="vhsHeadSwitching"> VHS Head Switching
            </div>
            <div class="control-item">
                <label>Head Switching Speed:</label>
                <input type="range" id="headSwitchingSpeed" min="0" max="10" step="1" value="0">
                <span id="headSwitchingSpeedValue">0</span>
            </div>
            <div class="control-item">
                <input type="checkbox" id="vhsChromaVertBlend" checked> VHS Chroma Vertical Blend
            </div>
            <div class="control-item">
                <input type="checkbox" id="vhsSVideoOut"> VHS S-Video Out
            </div>
            <div class="control-item">
                <label>VHS Tape Speed:</label>
                <select id="outputVHSTapeSpeed">
                    <option value="0">SP (Standard Play)</option>
                    <option value="1">LP (Long Play)</option>
                    <option value="2">EP (Extended Play)</option>
                </select>
            </div>
        </div>
    </details>

    <!-- Scanline Controls -->
    <details>
        <summary><strong>Scanline & Phase</strong></summary>
        <div class="control-group">
            <div class="control-item">
                <label>Scanline Phase Shift:</label>
                <select id="videoScanlinePhaseShift">
                    <option value="0">0째</option>
                    <option value="90">90째</option>
                    <option value="180" selected>180째</option>
                    <option value="270">270째</option>
                </select>
            </div>
            <div class="control-item">
                <label>Phase Shift Offset:</label>
                <input type="range" id="videoScanlinePhaseShiftOffset" min="0" max="3" step="1" value="0">
                <span id="videoScanlinePhaseShiftOffsetValue">0</span>
            </div>
        </div>
    </details>

    <!-- System Controls -->
    <details>
        <summary><strong>System</strong></summary>
        <div class="control-group">
            <div class="control-item">
                <input type="checkbox" id="blackLineCut"> Black Line Cut
            </div>
            <div class="control-item">
                <input type="checkbox" id="precise"> Precise Mode
            </div>
            <div class="control-item">
                <input type="checkbox" id="outputNTSC" checked> Output NTSC
            </div>
            <div class="control-item">
                <input type="checkbox" id="enableDebugLog"> Enable Debug Log
            </div>
            <div class="control-item">
                <label>Random Seed:</label>
                <input type="number" id="randomSeed" min="0" max="4294967295" value="12345">
            </div>
            <div class="control-item">
                <label>Random Seed 2:</label>
                <input type="number" id="randomSeed2" min="0" max="4294967295" value="67890">
            </div>
        </div>
    </details>

    <div><input type="checkbox" id="enableCompression" checked> Enable auto-resize</div>
    <div id="compressionSettings">
        Max Width (0 = no limit): <input type="number" id="maxWidth" min="0" max="4096" value="480"><br>
        Max Height (0 = no limit): <input type="number" id="maxHeight" min="0" max="4096" value="0">
    </div>


    <div id="error" style="display: none; color: red;"></div>

    <div id="imageDisplay" style="display: none;">
        <div class="image-container">
            <div class="image-section">
                <h3>Original</h3>
                <img id="originalImage">
            </div>
            <div class="image-section">
                <h3>Processed</h3>
                <img id="processedImage">
            </div>
        </div>
    </div>
    <div id="processStatus" style="display: none;">Processing image...</div>
    <div id="tech-overview" class="section">
        <!-- Technical implementation content will be inserted here during build -->
    </div>

    <script>
        let wasmWorker = null;
        let wasmReady = false;
        let currentImageData = null;
        let currentRequestId = 0;
        let processingRequestId = null;

        // Initialize Web Worker
        function initWorker() {
            wasmWorker = new Worker('worker.js');

            wasmWorker.onmessage = function (event) {
                const data = event.data;
                if (data.type === 'wasmLoaded') {
                    wasmReady = true;
                    document.getElementById('wasmStatus').textContent = 'Ready to process images!';
                    
                    // Initialize debug mode based on checkbox state
                    const debugEnabled = document.getElementById('enableDebugLog').checked;
                    wasmWorker.postMessage({ type: 'setDebugMode', enabled: debugEnabled });

                    if (currentImageData) { 
                        processImage();
                    }
                } else if (data.type === 'result') {
                    if (data.requestId && data.requestId !== processingRequestId) {
                        return;
                    }
                    const processedImage = document.getElementById('processedImage');
                    processedImage.src = data.imageData;
                    document.getElementById('processStatus').style.display = 'none';
                    document.getElementById('processStatus').textContent = 'Processing time: ' + data.processTime + ' ms';
                    document.getElementById('processStatus').style.display = 'block';
                    processingRequestId = null;
                } else if (data.type === 'error') {
                    if (data.requestId && data.requestId !== processingRequestId) {
                        return;
                    }
                    showError(data.message);
                    document.getElementById('processStatus').style.display = 'none';
                    processingRequestId = null;

                }
            };

            wasmWorker.onerror = function (error) {
                console.error('Worker error:', error);
                showError('Web Worker encountered an error.');
                document.getElementById('wasmStatus').textContent = 'Failed to load WebAssembly module';
                document.getElementById('loading').style.display = 'none';

            };
        }

        initWorker(); // Call to initialize the worker

        document.getElementById('fileInput').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please select an image file');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                currentImageData = e.target.result;
                document.getElementById('originalImage').src = currentImageData;
                document.getElementById('imageDisplay').style.display = 'block';

                if (wasmReady) {
                    processImage();
                }
            };
            reader.readAsDataURL(file);
        }

        function updateSliderValues() {
            const sliders = document.querySelectorAll('input[type="range"]');
            sliders.forEach(slider => {
                const valueElement = document.getElementById(slider.id + 'Value');
                if (valueElement) {
                    valueElement.textContent = slider.value;
                    slider.addEventListener('input', () => {
                        valueElement.textContent = slider.value;
                        if (currentImageData && wasmReady) {
                            processImage();
                        }
                    });
                }
            });
            
            // Add listeners for checkboxes
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.id === 'enableDebugLog') {
                    // Special handling for debug log checkbox
                    checkbox.addEventListener('change', () => {
                        if (wasmReady) {
                            wasmWorker.postMessage({ type: 'setDebugMode', enabled: checkbox.checked });
                        }
                    });
                } else {
                    checkbox.addEventListener('change', () => {
                        if (currentImageData && wasmReady) {
                            processImage();
                        }
                    });
                }
            });
        }

        function loadPreset(presetName) {
            if (!wasmReady) {
                showError('WebAssembly module not ready');
                return;
            }

            // Send message to worker to get preset config
            wasmWorker.postMessage({ type: 'getPreset', presetName: presetName });

            wasmWorker.onmessage = function (event) {
                const data = event.data;
                if (data.type === 'presetConfig') {
                    const config = JSON.parse(data.config);
                    document.getElementById('compositePreemphasis').value = config.CompositePreemphasis || 0;
                    document.getElementById('colorBleedHoriz').value = config.ColorBleedHoriz || 0;
                    document.getElementById('ringing').value = config.Ringing || 0;
                    document.getElementById('videoNoise').value = config.VideoNoise || 0;
                    document.getElementById('videoChromaNoise').value = config.VideoChromaNoise || 0;
                    document.getElementById('vhsOutSharpen').value = config.VHSOutSharpen || 0;
                    document.getElementById('vhsChromaVertBlend').checked = config.VHSChromaVertBlend || false;
                    document.getElementById('headSwitchingSpeed').value = config.HeadSwitchingSpeed || 0;
                    document.getElementById('blackLineCut').checked = config.BlackLineCut || false;
                    document.getElementById('precise').checked = config.Precise || false;
                    updateSliderValues();
                } else if (data.type === 'error') {
                    showError(data.message);
                }
                // Re-attach the main onmessage handler after preset is loaded
                initWorker();
            };
        }

        async function processImage() {
            if (!wasmReady) {
                showError('WebAssembly module not ready');
                return;
            }

            if (!currentImageData) {
                showError('Please upload an image first');
                return;
            }

            // Generate new request ID and cancel any previous processing
            currentRequestId++;
            const requestId = currentRequestId;
            processingRequestId = requestId;

            const processStatus = document.getElementById('processStatus');
            const errorDiv = document.getElementById('error');
            processStatus.style.display = 'block';
            processStatus.textContent = 'Processing image...';
            errorDiv.style.display = 'none';

            const config = {
                CompositePreemphasis: parseFloat(document.getElementById('compositePreemphasis').value),
                CompositePreemphasisCut: parseFloat(document.getElementById('compositePreemphasisCut').value),
                ColorBleedBefore: document.getElementById('colorBleedBefore').checked,
                ColorBleedHoriz: parseInt(document.getElementById('colorBleedHoriz').value),
                ColorBleedVert: parseInt(document.getElementById('colorBleedVert').value),
                Ringing: parseFloat(document.getElementById('ringing').value),
                EnableRinging2: document.getElementById('enableRinging2').checked,
                RingingPower: parseInt(document.getElementById('ringingPower').value),
                RingingShift: parseInt(document.getElementById('ringingShift').value),
                FreqNoiseSize: parseFloat(document.getElementById('freqNoiseSize').value),
                FreqNoiseAmplitude: parseFloat(document.getElementById('freqNoiseAmplitude').value),
                CompositeInChromaLowpass: document.getElementById('compositeInChromaLowpass').checked,
                CompositeOutChromaLowpass: document.getElementById('compositeOutChromaLowpass').checked,
                CompositeOutChromaLowpassLite: document.getElementById('compositeOutChromaLowpassLite').checked,
                VideoNoise: parseInt(document.getElementById('videoNoise').value),
                VideoChromaNoise: parseInt(document.getElementById('videoChromaNoise').value),
                VideoChromaPhaseNoise: parseInt(document.getElementById('videoChromaPhaseNoise').value),
                VideoChromaLoss: parseInt(document.getElementById('videoChromaLoss').value),
                SubcarrierAmplitude: parseInt(document.getElementById('subcarrierAmplitude').value),
                SubcarrierAmplitudeBack: parseInt(document.getElementById('subcarrierAmplitude').value),
                EmulatingVHS: document.getElementById('emulatingVHS').checked,
                NoColorSubcarrier: document.getElementById('noColorSubcarrier').checked,
                VHSChromaVertBlend: document.getElementById('vhsChromaVertBlend').checked,
                VHSSVideoOut: document.getElementById('vhsSVideoOut').checked,
                VHSOutSharpen: parseFloat(document.getElementById('vhsOutSharpen').value),
                VHSEdgeWave: parseInt(document.getElementById('vhsEdgeWave').value),
                VHSHeadSwitching: document.getElementById('vhsHeadSwitching').checked,
                VHSHeadSwitchingPhaseNoise: 0.05,
                OutputNTSC: document.getElementById('outputNTSC').checked,
                VideoScanlinePhaseShift: parseInt(document.getElementById('videoScanlinePhaseShift').value),
                VideoScanlinePhaseShiftOffset: parseInt(document.getElementById('videoScanlinePhaseShiftOffset').value),
                OutputVHSTapeSpeed: parseInt(document.getElementById('outputVHSTapeSpeed').value),
                HeadSwitchingSpeed: parseInt(document.getElementById('headSwitchingSpeed').value),
                BlackLineCut: document.getElementById('blackLineCut').checked,
                Precise: document.getElementById('precise').checked,
                RandomSeed: parseInt(document.getElementById('randomSeed').value),
                RandomSeed2: parseInt(document.getElementById('randomSeed2').value)
            };

            const enableCompression = document.getElementById('enableCompression').checked;
            const maxWidth = enableCompression ? parseInt(document.getElementById('maxWidth').value) || 0 : 0;
            const maxHeight = enableCompression ? parseInt(document.getElementById('maxHeight').value) || 0 : 0;

            let imageDataToSend = currentImageData;

            if (enableCompression && (maxWidth > 0 || maxHeight > 0)) {
                try {
                    imageDataToSend = await resizeImage(currentImageData, maxWidth, maxHeight);
                } catch (error) {
                    if (requestId === currentRequestId) {
                        showError('Failed to resize image: ' + error.message);
                        processStatus.style.display = 'none';
                    }
                    return;
                }
            }

            // Check if this request is still current before sending
            if (requestId !== currentRequestId) {
                return;
            }

            const request = {
                imageData: imageDataToSend,
                config: config,
                maxWidth: maxWidth,
                maxHeight: maxHeight,
                requestId: requestId
            };

            // Send message to worker to process image
            wasmWorker.postMessage({ type: 'processImage', request: request });
        }

        async function resizeImage(base64Data, maxWidth, maxHeight) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (maxWidth > 0 && width > maxWidth) {
                        height = height * (maxWidth / width);
                        width = maxWidth;
                    }

                    if (maxHeight > 0 && height > maxHeight) {
                        width = width * (maxHeight / height);
                        height = maxHeight;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    resolve(canvas.toDataURL('image/png')); // Always convert to PNG for consistency
                };
                img.onerror = (error) => {
                    reject(error);
                };
                img.src = base64Data;
            });
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function toggleCompressionSettings() {
            const enableCompression = document.getElementById('enableCompression');
            const compressionSettings = document.getElementById('compressionSettings');

            compressionSettings.style.display = enableCompression.checked ? 'block' : 'none';
        }

        document.getElementById('enableCompression').addEventListener('change', toggleCompressionSettings);

        updateSliderValues();
        toggleCompressionSettings();

        // Add real-time listeners for number inputs
        const numberInputs = document.querySelectorAll('input[type="number"]');
        numberInputs.forEach(input => {
            input.addEventListener('input', () => {
                if (currentImageData && wasmReady) {
                    processImage();
                }
            });
        });

        // Add real-time listener for compression checkbox
        document.getElementById('enableCompression').addEventListener('change', () => {
            if (currentImageData && wasmReady) {
                processImage();
            }
        });

        document.addEventListener("DOMContentLoaded", function () {
            renderMathInElement(document.body, {
                delimiters: [
                    { left: '\\(', right: '\\)', display: false },
                    { left: '\\[', right: '\\]', display: true }
                ]
            });
        });
    </script>
</body>

</html>